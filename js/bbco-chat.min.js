!function(n){var e,o,t,a,i,s,c,r=window.BBCO_CHAT_AUTH_URL||"https://${URL_MOODLE}/local/tepuy/components/socket/index.php?uid=${MANIFEST_ID}&courseid=${COURSE_ID}",d=10,l=!1,u={CHATMSG:"chatmsg",CHATHISTORY:"chathistory",PLAYERCONNECTED:"playerconnected",PLAYERDISCONNECTED:"playerdisconnected"},h=!1,p=!1,f="",m={},v=1e3;m[u.CHATMSG]=function(n){I(n.data)},m[u.CHATHISTORY]=function(e){!t.user&&e.user&&e.user.id==t.userid&&(t.user=e.user,n(".chat-header .username").html("<strong>"+e.user.name+"</strong>"));var o,a=e.data;$loader=i.find(".loader").remove(),n.each(a,function(n,e){e.prepend=!0,I(e),o=e.id}),e.data.length==d&&($loader=n('<div class="loader">Ver mas</div>'),$loader.on("click",function(){R({action:u.CHATHISTORY,data:{n:d,s:o}})}),$loader.prependTo(i))},m[u.PLAYERCONNECTED]=function(n){},m[u.PLAYERDISCONNECTED]=function(n){};var b="es",g={es:{"chat.error_connecting":'Hubo un error en la conexi√≥n. Reintentando en <strong class="reconnect-timeout"><span>${timeout}</span> seg</strong>.',"chat.try_connect":'<a class="btn reconnect">Reconectar ahora</a>'}};function y(n,e){var o=g[b][n];return e&&(o=C(o,e)),o}function C(n,e){for(var o in e)n=n.replace("${"+o+"}",e[o]);return n}function w(){if(l)return function(){for(var n,e=[],o=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),t=0;t<o.length;t++)n=o[t].split("="),e.push(n[0]),e[n[0]]=n[1];return"json/fakeauth_"+(e.id||"2")+".json"}();var e={MANIFEST_ID:n("body").data().manifestId||"",COURSE_ID:parent&&parent.window.scormplayerdata?parent.window.scormplayerdata.courseid:"",URL_MOODLE:window.location.host};return C(r,e)}function T(){var e;return o=n.Deferred(),(e=n.Deferred(),n.getJSON(w()).done(function(n){e.resolve(n)}).fail(function(n){e.reject(n)}),e.promise()).then(function(n){t=n,o.resolve(n)},function(n){o.reject(n)}),o.promise()}function k(){var i;return o=n.Deferred(),i=l?"ws://"+t.serverurl+"?skey="+t.skey:(!1===t.secure?"ws://":"wss://")+t.serverurl+"?skey="+t.skey,a.addClass("loading"),(e=new WebSocket(i)).onopen=function(){p=!0,a.removeClass("loading"),o.resolve(e)},e.onerror=function(n){a.removeClass("loading"),o.reject(n)},o.promise()}function E(e){e.onmessage=A,e.onclose=S,e.onerror=D,t.userpicture&&n('<img src="'+t.userpicture+'" alt="" />').appendTo(a.find(".chat-header .avatar").empty()),i.empty(),R({action:u.CHATHISTORY,data:{n:d,s:f}})}function O(){o=n.Deferred(),k(),o.then(function(n){s=0,v=1e3,E(n)},function(){(v*=2)/1e3>512||(s=0,x())})}function H(){p||(clearTimeout(c),v>1e3&&(v/=2),O())}function S(n){n.wasClean||(p=!1,I({msg:y("chat.error_connecting",{timeout:v/1e3}),issystem:1}),I({msg:y("chat.try_connect"),issystem:1}),s=0,x())}function D(n){1!=e.readystate&&(s=0,x())}function x(){var n=(v-s)/1e3;i.find(".reconnect-timeout span").text(n),0!=n?(s+=1e3,c=setTimeout(x,1e3)):O()}function A(n){try{var e=JSON.parse(n.data);0,h&&console.log(e);var o=m[e.action];o&&o.apply(this,[e])}catch(n){console.log(n)}}function R(n){p&&e.send(JSON.stringify(n))}function _(){if(p){var e=n(".bbco-chat-container .chat-input").html();if(""!=e){var o={action:u.CHATMSG,data:e};R(o),I({user:t.user,msg:o.data}),n(".bbco-chat-container .chat-input").empty()}}}function I(e){var o=n('<li class="message"></li>'),a=n("<p></p>"),s=null==e.user||e.user.id==t.userid,c=e.msg,r=new Date(1e3*e.timestamp).toLocaleString(),d=s?"":e.user.name;"1"!==e.issystem&&1!==e.issystem||(o.addClass("system"),d="<span>("+r+")</span> "+d),a.html(c),s||a.prepend(n('<label class="title"></label>').html(d)),o.append(a),s&&o.addClass("sent"),e.prepend?o.prependTo(i):(o.appendTo(i),i.stop().animate({scrollTop:i[0].scrollHeight},400))}function N(n){_()}function L(n){if(13===n.keyCode)return setTimeout(_,0),!1}function M(n){}function $(e){n(this).is(".minimize")?a.addClass("collapsed"):a.removeClass("collapsed")}function Y(){}function j(){}n.fn.bbcochat=function(e){var o=n.extend({authurl:""},e);return r=o.authurl,T().then(function(){var e;e=['<div class="bbco-chat-container">','<svg width="0" height="0" style="position:absolute;">','<symbol viewBox="0 0 512 512" id="ion-android-send">','<path d="M48 448l416-192L48 64v149.333L346 256 48 298.667z"/>',"</symbol>",'<symbol viewBox="0 0 512 512" id="ion-android-remove">','<path d="M96 235h320v42H96z"/>',"</symbol>",'<symbol viewBox="0 0 512 512" id="ion-android-checkbox-outline-blank">','<path d="M405.333 106.667v298.666H106.667V106.667h298.666m0-42.667H106.667C83.198 64 64 83.198 64 106.667v298.666C64 428.802 83.198 448 106.667 448h298.666C428.802 448 448 428.802 448 405.333V106.667C448 83.198 428.802 64 405.333 64z"/>',"</symbol>","</svg>",'<div class="bbco-chat-container-wrapper">','<div class="chat-header">','<div class="avatar"></div>','<div class="username"></div>','<svg class="ion ion-android-remove minimize window-action">','<use xlink:href="#ion-android-remove"></use>',"</svg>",'<svg class="ion ion-android-checkbox-outline-blank maximize window-action">','<use xlink:href="#ion-android-checkbox-outline-blank"></use>',"</svg>","</div>",'<ul class="chat-history"></ul>','<div class="chat-box">','<div class="chat-input" contenteditable="true"></div>','<button class="btn send">','<svg class="ion ion-android-send"> ','<use xlink:href="#ion-android-send"></use>',"</svg>","</button>","</div>","</div>","</div>"].join(""),n("body").append(e),a=n(".bbco-chat-container"),(i=n(".bbco-chat-container .chat-history")).on("click",".btn.reconnect",H),n(".bbco-chat-container .btn.send").on("click",N),n(".bbco-chat-container .chat-input").keydown(L),a.find(".chat-header").on("click",".window-action",$),i.on("scroll",M),a.data("bbcoChat",{close:Y,open:j}),k().then(function(n){E(n)},function(n){console.log("Error connecting to socket"),console.log(n)})},function(n){console.log("Error loading bbcochat"),console.log(n)}),this}}(jQuery);
