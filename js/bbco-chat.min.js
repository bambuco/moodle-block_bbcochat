!function(n){var e,o,t,i,a,s,c,r=window.BBCO_CHAT_AUTH_URL||"https://${URL_MOODLE}/local/tepuy/components/socket/index.php?uid=${MANIFEST_ID}&courseid=${COURSE_ID}",d=10,l=!1,u=["playerconnected","playerdisconnected"],h={CHATMSG:"chatmsg",CHATHISTORY:"chathistory",PLAYERCONNECTED:"playerconnected",PLAYERDISCONNECTED:"playerdisconnected"},p=!1,f=!1,m="",v={},b=1e3;v[h.CHATMSG]=function(n){N(n.data)},v[h.CHATHISTORY]=function(e){!t.user&&e.user&&e.user.id==t.userid&&(t.user=e.user,n(".chat-header .username").html("<strong>"+e.user.name+"</strong>"));var o,i=e.data;$loader=a.find(".loader").remove(),n.each(i,function(n,e){e.prepend=!0,N(e),o=e.id}),e.data.length==d&&($loader=n('<div class="loader">Ver mas</div>'),$loader.on("click",function(){_({action:h.CHATHISTORY,data:{n:d,s:o}})}),$loader.prependTo(a))},v[h.PLAYERCONNECTED]=function(n){},v[h.PLAYERDISCONNECTED]=function(n){};var g="es",y={es:{"chat.error_connecting":'Hubo un error en la conexi√≥n. Reintentando en <strong class="reconnect-timeout"><span>${timeout}</span> seg</strong>.',"chat.try_connect":'<a class="btn reconnect">Reconectar ahora</a>'}};function C(n,e){var o=y[g][n];return e&&(o=w(o,e)),o}function w(n,e){for(var o in e)n=n.replace("${"+o+"}",e[o]);return n}function T(){if(l)return function(){for(var n,e=[],o=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),t=0;t<o.length;t++)n=o[t].split("="),e.push(n[0]),e[n[0]]=n[1];return"json/fakeauth_"+(e.id||"2")+".json"}();var e={MANIFEST_ID:n("body").data().manifestId||"",COURSE_ID:parent&&parent.window.scormplayerdata?parent.window.scormplayerdata.courseid:"",URL_MOODLE:window.location.host};return w(r,e)}function k(){var e;return o=n.Deferred(),(e=n.Deferred(),n.getJSON(T()).done(function(n){e.resolve(n)}).fail(function(n){e.reject(n)}),e.promise()).then(function(n){t=n,o.resolve(n)},function(n){o.reject(n)}),o.promise()}function E(){var a;return o=n.Deferred(),a=l?"ws://"+t.serverurl+"?skey="+t.skey:(!1===t.secure?"ws://":"wss://")+t.serverurl+"?skey="+t.skey,i.addClass("loading"),(e=new WebSocket(a)).onopen=function(){f=!0,i.removeClass("loading"),o.resolve(e)},e.onerror=function(n){i.removeClass("loading"),o.reject(n)},o.promise()}function O(e){e.onmessage=R,e.onclose=D,e.onerror=x,t.userpicture&&n('<img src="'+t.userpicture+'" alt="" />').appendTo(i.find(".chat-header .avatar").empty()),a.empty(),_({action:h.CHATHISTORY,data:{n:d,s:m}})}function H(){o=n.Deferred(),E(),o.then(function(n){s=0,b=1e3,O(n)},function(){(b*=2)/1e3>512||(s=0,A())})}function S(){f||(clearTimeout(c),b>1e3&&(b/=2),H())}function D(n){n.wasClean||(f=!1,N({msg:C("chat.error_connecting",{timeout:b/1e3}),issystem:1}),N({msg:C("chat.try_connect"),issystem:1}),s=0,A())}function x(n){1!=e.readystate&&(s=0,A())}function A(){var n=(b-s)/1e3;a.find(".reconnect-timeout span").text(n),0!=n?(s+=1e3,c=setTimeout(A,1e3)):H()}function R(n){try{var e=JSON.parse(n.data);0,p&&console.log(e);var o=v[e.action];o&&o.apply(this,[e])}catch(n){console.log(n)}}function _(n){f&&e.send(JSON.stringify(n))}function I(){if(f){var e=n(".bbco-chat-container .chat-input").html();if(""!=e){var o={action:h.CHATMSG,data:e};_(o),N({user:t.user,msg:o.data}),n(".bbco-chat-container .chat-input").empty()}}}function N(e){if(("1"===e.issystem||1===e.issystem)&&e.originalaction&&u.includes(e.originalaction))return!0;var o=n('<li class="message"></li>'),i=n("<p></p>"),s=null==e.user||e.user.id==t.userid,c=e.msg,r=new Date(1e3*e.timestamp).toLocaleString(),d=s?"":e.user.name;"1"!==e.issystem&&1!==e.issystem||(o.addClass("system"),d="<span>("+r+")</span> "+d),i.html(c),s||i.prepend(n('<label class="title"></label>').html(d)),o.append(i),s&&o.addClass("sent"),e.prepend?o.prependTo(a):(o.appendTo(a),a.stop().animate({scrollTop:a[0].scrollHeight},400))}function L(n){I()}function M(n){if(13===n.keyCode)return setTimeout(I,0),!1}function $(n){}function Y(e){n(this).is(".minimize")?i.addClass("collapsed"):i.removeClass("collapsed")}function j(){}function z(){}n.fn.bbcochat=function(e){var o=n.extend({authurl:""},e);return r=o.authurl,k().then(function(){var e;e=['<div class="bbco-chat-container">','<svg width="0" height="0" style="position:absolute;">','<symbol viewBox="0 0 512 512" id="ion-android-send">','<path d="M48 448l416-192L48 64v149.333L346 256 48 298.667z"/>',"</symbol>",'<symbol viewBox="0 0 512 512" id="ion-android-remove">','<path d="M96 235h320v42H96z"/>',"</symbol>",'<symbol viewBox="0 0 512 512" id="ion-android-checkbox-outline-blank">','<path d="M405.333 106.667v298.666H106.667V106.667h298.666m0-42.667H106.667C83.198 64 64 83.198 64 106.667v298.666C64 428.802 83.198 448 106.667 448h298.666C428.802 448 448 428.802 448 405.333V106.667C448 83.198 428.802 64 405.333 64z"/>',"</symbol>","</svg>",'<div class="bbco-chat-container-wrapper">','<div class="chat-header">','<div class="avatar"></div>','<div class="username"></div>','<svg class="ion ion-android-remove minimize window-action">','<use xlink:href="#ion-android-remove"></use>',"</svg>",'<svg class="ion ion-android-checkbox-outline-blank maximize window-action">','<use xlink:href="#ion-android-checkbox-outline-blank"></use>',"</svg>","</div>",'<ul class="chat-history"></ul>','<div class="chat-box">','<div class="chat-input" contenteditable="true"></div>','<button class="btn send">','<svg class="ion ion-android-send"> ','<use xlink:href="#ion-android-send"></use>',"</svg>","</button>","</div>","</div>","</div>"].join(""),n("body").append(e),i=n(".bbco-chat-container"),(a=n(".bbco-chat-container .chat-history")).on("click",".btn.reconnect",S),n(".bbco-chat-container .btn.send").on("click",L),n(".bbco-chat-container .chat-input").keydown(M),i.find(".chat-header").on("click",".window-action",Y),a.on("scroll",$),i.data("bbcoChat",{close:j,open:z}),E().then(function(n){O(n)},function(n){console.log("Error connecting to socket"),console.log(n)})},function(n){console.log("Error loading bbcochat"),console.log(n)}),this}}(jQuery);